var b=Object.defineProperty;var g=(c,t,e)=>t in c?b(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var i=(c,t,e)=>g(c,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();class y{constructor(){i(this,"db",null);i(this,"observers",new Set);i(this,"dbName","CompanyDB");i(this,"storeName","companies");i(this,"version",2);i(this,"cache",null);this.initDB()}async initDB(){return new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{console.error("Ошибка открытия базы данных:",s.error),e(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("База данных успешно открыта"),this.loadAllCompanies(),t()},s.onupgradeneeded=n=>{const o=n.target.result;n.target.transaction&&o.objectStoreNames.contains(this.storeName)&&o.deleteObjectStore(this.storeName);const r=o.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});r.createIndex("companyName","companyName",{unique:!1}),r.createIndex("directorFullName","directorFullName",{unique:!1}),console.log("Object store создан с новой схемой")}})}subscribe(t){return this.observers.add(t),this.loadAllCompanies(),()=>{this.observers.delete(t)}}notifyObservers(t){this.observers.forEach(e=>{try{e(t)}catch(s){console.error("Ошибка в observer:",s)}})}async addCompany(t){if(!this.db)throw new Error("База данных не инициализирована");return new Promise((e,s)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).add(t);a.onsuccess=()=>{console.log("Компания добавлена с ID:",a.result),this.invalidateCache(),this.loadAllCompanies(),e()},a.onerror=()=>{console.error("Ошибка добавления компании:",a.error),s(a.error)}})}async updateCompany(t){if(!this.db)throw new Error("База данных не инициализирована");return new Promise((e,s)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(t);a.onsuccess=()=>{console.log("Компания обновлена"),this.invalidateCache(),this.loadAllCompanies(),e()},a.onerror=()=>{console.error("Ошибка обновления компании:",a.error),s(a.error)}})}async deleteCompany(t){if(!this.db)throw new Error("База данных не инициализирована");return new Promise((e,s)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(t);a.onsuccess=()=>{console.log("Компания удалена"),this.invalidateCache(),this.loadAllCompanies(),e()},a.onerror=()=>{console.error("Ошибка удаления компании:",a.error),s(a.error)}})}async loadAllCompanies(){if(this.db)return new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();o.onsuccess=()=>{const a=o.result;this.cache=a,this.notifyObservers(a),t()},o.onerror=()=>{console.error("Ошибка загрузки компаний:",o.error),e(o.error)}})}async loadAllCompaniesToCache(){if(this.db)return new Promise((t,e)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();o.onsuccess=()=>{this.cache=o.result,t()},o.onerror=()=>{console.error("Ошибка загрузки компаний в кэш:",o.error),e(o.error)}})}async getCompaniesPage(t,e,s,n,o){if(this.cache||await this.loadAllCompaniesToCache(),!this.cache)return{companies:[],totalPages:0,currentPage:t};let a=[...this.cache];if(s!=null&&s.trim()){const l=s.trim().toLowerCase();a=a.filter(h=>(h.directorFullName||"").toLowerCase().includes(l))}n&&a.sort((l,h)=>{const u=String(l[n]||"").toLowerCase(),m=String(h[n]||"").toLowerCase();return u<m?o==="asc"?-1:1:u>m?o==="asc"?1:-1:0});const r=Math.ceil(a.length/e),d=(t-1)*e,p=d+e;return{companies:a.slice(d,p),totalPages:r,currentPage:t}}invalidateCache(){this.cache=null}async getCompanyById(t){if(!this.db)throw new Error("База данных не инициализирована");return new Promise((e,s)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);a.onsuccess=()=>{e(a.result||null)},a.onerror=()=>{console.error("Ошибка получения компании:",a.error),s(a.error)}})}}class f{constructor(t){i(this,"database");i(this,"currentEditId",null);i(this,"companyNameInput");i(this,"directorNameInput");i(this,"phoneInput");i(this,"cityInput");i(this,"streetInput");i(this,"houseInput");i(this,"addBtn");i(this,"modal");i(this,"modalTitle");i(this,"openModalBtn");i(this,"closeModalBtn");this.database=t,this.companyNameInput=document.getElementById("modalCompanyName"),this.directorNameInput=document.getElementById("modalDirectorFullName"),this.phoneInput=document.getElementById("modalPhoneNumber"),this.cityInput=document.getElementById("modalCity"),this.streetInput=document.getElementById("modalStreet"),this.houseInput=document.getElementById("modalHouse"),this.addBtn=document.getElementById("modalAddBtn"),this.modal=document.getElementById("companyModal"),this.modalTitle=document.getElementById("modalTitle"),this.openModalBtn=document.getElementById("openModalBtn"),this.closeModalBtn=document.getElementById("closeModalBtn"),this.initializeEventListeners(),this.setupValidation()}initializeEventListeners(){this.addBtn.addEventListener("click",()=>this.handleSubmit()),this.openModalBtn.addEventListener("click",()=>this.openModal()),this.closeModalBtn.addEventListener("click",()=>this.closeModal()),this.modal.addEventListener("click",t=>{t.target===this.modal&&this.closeModal()}),document.addEventListener("companyEdit",t=>{const e=t;this.loadCompanyForEdit(e.detail)})}setupValidation(){const t=[this.companyNameInput,this.directorNameInput,this.phoneInput,this.cityInput,this.streetInput,this.houseInput],e=()=>{const s=t.every(n=>n.value.trim()!=="");this.addBtn.disabled=!s,s?this.addBtn.classList.add("btn--primary"):this.addBtn.classList.remove("btn--primary")};t.forEach(s=>{s.addEventListener("input",e)}),e()}async handleSubmit(){const t={city:this.cityInput.value.trim(),street:this.streetInput.value.trim(),house:this.houseInput.value.trim()},e={companyName:this.companyNameInput.value.trim(),directorFullName:this.directorNameInput.value.trim(),phoneNumber:this.phoneInput.value.trim(),address:t};if(this.validateData(e))try{if(this.currentEditId){const s={...e,id:this.currentEditId};await this.database.updateCompany(s),this.addBtn.textContent="Добавить",this.currentEditId=null}else await this.database.addCompany(e);this.closeModal()}catch(s){console.error("Ошибка сохранения компании:",s),alert("Ошибка сохранения компании")}}validateData(t){return!!(t.companyName&&t.directorFullName&&t.phoneNumber&&t.address)}loadCompanyForEdit(t){this.companyNameInput.value=t.companyName,this.directorNameInput.value=t.directorFullName,this.phoneInput.value=t.phoneNumber,this.cityInput.value=t.address.city,this.streetInput.value=t.address.street,this.houseInput.value=t.address.house,this.currentEditId=t.id,this.addBtn.textContent="Сохранить изменения",this.modalTitle.textContent="Редактировать компанию",this.addBtn.disabled=!1,this.addBtn.classList.add("btn--primary"),this.openModal(),this.companyNameInput.focus()}clearForm(){this.companyNameInput.value="",this.directorNameInput.value="",this.phoneInput.value="",this.cityInput.value="",this.streetInput.value="",this.houseInput.value="",this.currentEditId=null,this.addBtn.textContent="Добавить",this.modalTitle.textContent="Добавить компанию",this.addBtn.disabled=!0,this.addBtn.classList.remove("btn--primary")}openModal(){this.modal.classList.add("modal--show"),document.body.style.overflow="hidden"}closeModal(){this.modal.classList.remove("modal--show"),document.body.style.overflow="",this.clearForm()}}class I{constructor(t,e){i(this,"SORTABLE_FIELDS",["companyName","directorFullName"]);i(this,"tableBody");i(this,"database");i(this,"app");i(this,"paginationContainer");this.database=t,this.app=e,this.tableBody=document.getElementById("tableBody"),this.paginationContainer=document.getElementById("paginationContainer"),this.setupHeaderClickHandlers()}formatAddress(t){const{city:e,street:s,house:n}=t;if(!e&&!s&&!n)return"";const o=[],a=(r,d="")=>{r&&o.push(d?`${d} ${r}`:r)};return a(e,"г."),a(s),a(n),o.join(", ")}renderTable(t){this.tableBody.innerHTML="",t.forEach(e=>{const s=document.createElement("tr");s.setAttribute("data-id",String(e.id)),s.classList.add("table__row--clickable"),document.querySelectorAll("th[data-field]").forEach(a=>{const r=a.getAttribute("data-field"),d=document.createElement("td");r==="address"?d.textContent=this.formatAddress(e[r]):d.textContent=String(e[r]||""),s.appendChild(d)});const o=document.createElement("td");o.innerHTML=`
        <button class="delete-btn" data-id="${e.id}">&#88;</button>
      `,s.appendChild(o),this.tableBody.appendChild(s)}),this.attachEventListeners(),this.updateSortIndicators()}renderPagination(t,e){if(!this.paginationContainer)return;if(e<=1){this.paginationContainer.innerHTML="";return}const s=this.generatePageNumbers(t,e);let n='<div class="pagination">';t>1?n+=`<button class="pagination__btn" data-page="${t-1}">Предыдущая</button>`:n+='<button class="pagination__btn pagination__btn--disabled" disabled>Предыдущая</button>';let o=0;s.forEach(a=>{a-o>1&&(n+='<span class="pagination__dots">...</span>'),a===t?n+=`<button class="pagination__btn pagination__btn--active" data-page="${a}">${a}</button>`:n+=`<button class="pagination__btn" data-page="${a}">${a}</button>`,o=a}),t<e?n+=`<button class="pagination__btn" data-page="${t+1}">Следующая</button>`:n+='<button class="pagination__btn pagination__btn--disabled" disabled>Следующая</button>',n+="</div>",this.paginationContainer.innerHTML=n,this.setupPaginationHandlers()}generatePageNumbers(t,e){const s=[];e>0&&s.push(1);const n=Math.max(2,t-1),o=Math.min(e-1,t+1);for(let a=n;a<=o;a++)s.includes(a)||s.push(a);return e>1&&!s.includes(e)&&s.push(e),s}setupPaginationHandlers(){this.paginationContainer.querySelectorAll(".pagination__btn:not(.pagination__btn--disabled)").forEach(e=>{e.addEventListener("click",s=>{const n=s.target,o=parseInt(n.getAttribute("data-page")||"1");this.app.handlePageChange(o)})})}setupHeaderClickHandlers(){this.SORTABLE_FIELDS.forEach(t=>{const e=document.querySelector(`th[data-field="${t}"]`);e&&e.addEventListener("click",()=>{this.app.handleSort(t)})})}updateSortIndicators(){const t=document.querySelectorAll("th[data-field]"),e=this.app.getSortState();t.forEach(s=>{const n=s.getAttribute("data-field"),o=s.querySelector(".table__header-icon");if(o&&o.remove(),n&&this.SORTABLE_FIELDS.includes(n)){const a=document.createElement("i");a.className="table__header-icon",n===e.field?a.classList.add(`table__header-icon--${e.direction}`):a.classList.add("table__header-icon--unsorted"),s.appendChild(a)}})}attachEventListeners(){const t=document.querySelectorAll(".delete-btn"),e=document.querySelectorAll(".table__row--clickable");t.forEach(s=>{s.addEventListener("click",n=>{const o=n.target,a=parseInt(o.getAttribute("data-id")||"0");this.deleteCompany(a)})}),e.forEach(s=>{s.addEventListener("click",n=>{if(n.target.closest(".table__cell--actions"))return;const a=parseInt(s.getAttribute("data-id")||"0");this.editCompany(a)})})}async deleteCompany(t){try{await this.database.deleteCompany(t)}catch(e){console.error("Ошибка удаления компании:",e),alert("Ошибка удаления компании")}}async editCompany(t){console.log("editCompany",t);try{const e=await this.database.getCompanyById(t);if(e){const s=new CustomEvent("companyEdit",{detail:e});document.dispatchEvent(s)}}catch(e){console.error("Ошибка получения компании для редактирования:",e),alert("Ошибка загрузки данных компании")}}}class v{constructor(){i(this,"database");i(this,"tableManager");i(this,"filterInput");i(this,"sortField",null);i(this,"sortDirection","asc");i(this,"currentPage",1);i(this,"pageSize",5);i(this,"totalPages",0);i(this,"isDirectUrlNavigation",!1);this.database=new y,this.tableManager=new I(this.database,this),new f(this.database),this.filterInput=document.getElementById("filterInput"),this.parseUrlParams(),this.setupDatabaseSubscription()}setupDatabaseSubscription(){this.database.subscribe(()=>{this.loadPage()})}parseUrlParams(){const e=new URLSearchParams(window.location.search).get("page");if(e){const s=parseInt(e);s>0&&(this.isDirectUrlNavigation=!0,this.currentPage=s,this.resetFiltersAndSorting())}}resetFiltersAndSorting(){this.sortField=null,this.sortDirection="asc",this.filterInput&&(this.filterInput.value="")}updateUrl(t){const e=new URL(window.location.href);e.searchParams.set("page",t.toString()),window.history.pushState({},"",e.toString())}async loadPage(){var t;try{const e=this.isDirectUrlNavigation||(t=this.filterInput)==null?void 0:t.value,s=this.isDirectUrlNavigation?void 0:this.sortField,n=this.isDirectUrlNavigation?void 0:this.sortDirection,o=await this.database.getCompaniesPage(this.currentPage,this.pageSize,e,s||void 0,n);if(this.totalPages=o.totalPages,this.currentPage>this.totalPages&&this.totalPages>0){this.currentPage=1,this.updateUrl(1),await this.loadPage();return}this.tableManager.renderTable(o.companies),this.tableManager.renderPagination(this.currentPage,this.totalPages),this.isDirectUrlNavigation=!1}catch(e){console.error("Ошибка загрузки страницы:",e)}}async handlePageChange(t){t<1||t>this.totalPages||(this.currentPage=t,this.updateUrl(t),await this.loadPage())}async initialize(){try{await new Promise(t=>setTimeout(t,100)),this.setupFilterInput(),console.log("Приложение успешно инициализировано")}catch(t){console.error("Ошибка инициализации приложения:",t),alert("Ошибка инициализации приложения")}}setupFilterInput(){this.filterInput&&this.filterInput.addEventListener("input",()=>{this.currentPage=1,this.updateUrl(1),this.loadPage()})}handleSort(t){this.sortField===t?this.sortDirection==="asc"?this.sortDirection="desc":(this.sortField=null,this.sortDirection="asc"):(this.sortField=t,this.sortDirection="asc"),this.loadPage()}getSortState(){return{field:this.sortField,direction:this.sortDirection}}}const E=async()=>{await new v().initialize()};document.addEventListener("DOMContentLoaded",E);
